<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>LLM WebMail</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link rel="stylesheet" href="static/style.css" />
</head>

<body>
    {% raw %}
    <div id="app">
        <!-- AUTH GATE -->
        <div v-if="!authenticated" class="section">
            <div class="container" style="max-width: 480px;">
                <div class="box">
                    <h1 class="title is-flex is-align-items-center">
                        <span class="icon mr-2"><i class="fas fa-envelope"></i></span>
                        LLM WebMail
                    </h1>
                    <div class="tabs is-toggle is-fullwidth">
                        <ul>
                            <li :class="{ 'is-active': authMode==='login' }">
                                <a @click="authMode='login'">Login</a>
                            </li>
                            <li :class="{ 'is-active': authMode==='register' }">
                                <a @click="authMode='register'">Register</a>
                            </li>
                        </ul>
                    </div>
                    <div v-if="authMode==='login'">
                        <div class="field">
                            <label class="label">Username</label>
                            <div class="control"><input v-model="loginForm.username" class="input" /></div>
                        </div>
                        <div class="field">
                            <label class="label">Password</label>
                            <div class="control"><input v-model="loginForm.password" type="password" class="input" />
                            </div>
                        </div>
                        <button class="button is-primary is-fullwidth" @click="doLogin">Login</button>
                    </div>
                    <div v-else>
                        <div class="field">
                            <label class="label">Signup Key</label>
                            <div class="control"><input v-model="registerForm.key" class="input" /></div>
                        </div>
                        <div class="field">
                            <label class="label">Username</label>
                            <div class="control"><input v-model="registerForm.username" class="input" /></div>
                        </div>
                        <div class="field">
                            <label class="label">Password</label>
                            <div class="control"><input v-model="registerForm.password" type="password" class="input" />
                            </div>
                        </div>
                        <button class="button is-primary is-fullwidth" @click="doRegister">Register</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN APP (unchanged content wrapped in v-else) -->
        <div v-else class="main-wrapper">
            <!-- Main Content Area -->
            <div class="content-area">
                <div class="content-wrapper" style="position: relative;">
                    <!-- Top right checkbox -->
                    <div class="top-right">
                        <label class="checkbox">
                            <input type="checkbox" @change="toggleMaliciousEmail" />
                            Receive malicious email
                        </label>
                    </div>
                    <h1 class="title is-flex is-align-items-center">
                        <span class="icon mr-2"><i class="fas fa-envelope"></i></span>
                        LLM WebMail
                        <a target="_blank" href="https://reversec.com"><img class="logo"
                                src="static/reversec-logo.png"></a>

                        <!-- Admin button: aligned to the right, leave space for the checkbox -->
                        <button v-if="isAdmin" class="button is-small is-dark" style="margin-left:auto"
                            @click="openAdminConsole">
                            <span class="icon"><i class="fas fa-tools"></i></span>
                            <span>Admin Console</span>
                        </button>
                        <button v-if="authenticated" class="button is-small is-light ml-2" @click="doLogout">
                            <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
                            <span>Logout</span>
                        </button>
                    </h1>
                    <!-- Summary Section -->
                    <div v-if="inboxSummary && !loading" class="box has-background-success-light mb-4">
                        <div class="summary-controls">
                            <button class="button is-small is-primary" @click="summarizeInbox"
                                :disabled="quota.remaining===0">
                                <span class="icon"><i class="fas fa-sync-alt"></i></span>
                                <span>New Summary</span>
                                <span class="tag is-light" style="margin-left:.5rem">{{ quota.remaining }}/{{
                                    quota.limit }}</span>
                            </button>
                            <button class="delete" @click="clearSummary"></button>
                        </div>
                        <strong>Inbox Summary:</strong>
                        <div class="markdown" v-html="renderMarkdown(inboxSummary)"></div>
                    </div>
                    <div v-if="!inboxSummary && !loading" class="buttons mb-4">
                        <button class="button is-primary" @click="summarizeInbox" :disabled="quota.remaining===0">
                            <span class="icon"><i class="fas fa-magic"></i></span>
                            <span>Summarize My Inbox</span>
                            <span class="tag is-light" style="margin-left:.5rem">{{ quota.remaining }}/{{ quota.limit
                                }}</span>
                        </button>
                    </div>
                    <div v-if="loading"
                        class="box has-background-light mb-4 is-flex is-align-items-center is-justify-content-center">
                        <span class="icon is-large"><i class="fas fa-spinner fa-pulse"></i></span>
                    </div>
                    <!-- Emails List and Details -->
                    <div class="columns">
                        <div class="column is-one-third">
                            <div class="box">
                                <div class="email-list">
                                    <div v-for="email in emails" :key="email.id" class="email-item"
                                        @click="selectEmail(email)">
                                        <strong>{{ email.sender }}</strong>
                                        <small class="has-text-grey">{{ email.date }}</small>
                                        <p>{{ email.subject }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column">
                            <div v-if="selectedEmail" class="box">
                                <h2 class="subtitle">{{ selectedEmail.subject }}</h2>
                                <p><strong>From:</strong> {{ selectedEmail.sender }}</p>
                                <p><small>{{ selectedEmail.date }}</small></p>
                                <div class="buttons is-right mt-2 mb-2">
                                    <button v-if="!isEditing" @click="startEditing" class="button is-small is-info">
                                        <span class="icon"><i class="fas fa-edit"></i></span>
                                        <span>Edit</span>
                                    </button>
                                    <button v-else @click="saveEdits" class="button is-small is-success">
                                        <span class="icon"><i class="fas fa-save"></i></span>
                                        <span>Save</span>
                                    </button>
                                    <button v-if="isEditing" @click="cancelEditing" class="button is-small is-danger">
                                        <span class="icon"><i class="fas fa-times"></i></span>
                                        <span>Cancel</span>
                                    </button>
                                </div>
                                <hr />
                                <div v-if="!isEditing" v-html="renderPlain(getEmailBody(selectedEmail))"></div>
                                <textarea v-else v-model="editedBody" class="textarea" rows="10"></textarea>

                                <div v-if="isEdited(selectedEmail)" class="notification is-warning mt-3">
                                    <strong>Warning:</strong> This email has been locally edited. Changes will be lost
                                    on page refresh.
                                </div>
                            </div>
                            <div v-else class="notification is-info">
                                Select an email to view details.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Side Panel for Configuration -->
            <div class="side-panel" :class="{ active: showConfigPanel }">
                <div class="toggle-handle" @click="toggleConfigPanel">
                    <i :class="showConfigPanel ? 'fas fa-chevron-right' : 'fas fa-chevron-left'"></i>
                </div>
                <div class="panel-content" style="padding: 1rem;" v-if="showConfigPanel">
                    <header class="title is-5">Configuration</header>
                    <!-- Inside the side panel, LLM dropdown: -->
                    <div class="field">
                        <label class="label">LLM</label>
                        <div class="control">
                            <div class="select">
                                <select v-model="config.llm.selected" @change="updateConfig">
                                    <option v-for="m in llmOptions" :key="m.key" :value="m.key">
                                        {{ m.label }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Prompt Engineering</label>
                        <div class="control">
                            <div class="select">
                                <select v-model="config.prompt_engineering.mode" @change="updateConfig">
                                    <option value="disabled">disabled</option>
                                    <option value="basic">basic</option>
                                    <option value="system">system</option>
                                    <option value="system+spotlighting">system+spotlighting</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Prompt Injection Filter</label>
                        <div class="control">
                            <div class="select">
                                <select v-model="config.prompt_injection_filter.mode" @change="updateConfig">
                                    <option value="disabled">disabled</option>
                                    <option value="azure-prompt-shields">Azure Prompt Shields</option>
                                    <option value="aws-bedrock-guardrails">AWS Bedrock Guardrails</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Delimiter Filtering</label>
                        <div class="control">
                            <div class="select">
                                <select v-model="config['delimiter-filtering'].mode" @change="updateConfig">
                                    <option value="disabled">disabled</option>
                                    <option value="escape">escape</option>
                                    <option value="remove">remove</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label">Logging Verbose</label>
                        <div class="control">
                            <div class="select">
                                <select v-model="config.logging.verbose" @change="updateConfig">
                                    <option :value="true">Enabled</option>
                                    <option :value="false">Disabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- end v-else main-wrapper -->
        <!-- Admin Console Modal -->
        <div class="modal" :class="{ 'is-active': adminConsoleOpen }" v-if="isAdmin">
            <div class="modal-background" @click="closeAdminConsole"></div>
            <div class="modal-card admin-modal">
                <header class="modal-card-head">
                    <p class="modal-card-title">Admin Console</p>
                    <button class="delete" aria-label="close" @click="closeAdminConsole"></button>
                </header>
                <section class="modal-card-body">
                    <div class="tabs is-boxed">
                        <ul>
                            <li :class="{ 'is-active': adminTab==='users' }"><a @click="adminTab='users'">Users</a></li>
                            <li :class="{ 'is-active': adminTab==='keys' }"><a @click="adminTab='keys'">Signup Keys</a>
                            </li>
                        </ul>
                    </div>

                    <!-- Users tab -->
                    <div v-show="adminTab==='users'">
                        <div v-if="admin.users.length===0" class="notification is-light">No users.</div>
                        <table v-else class="table is-fullwidth is-striped is-hoverable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th style="width:240px">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="u in admin.users" :key="u.id">
                                    <td>{{ u.username }}</td>
                                    <td>{{ u.role }}</td>
                                    <td>
                                        <button class="button is-small" @click="resetUserPassword(u.username)">Reset
                                            PW</button>
                                        <button class="button is-small is-danger"
                                            @click="deleteUser(u.username)">Delete</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Keys tab -->
                    <div v-show="adminTab==='keys'">
                        <div class="is-flex is-align-items-center is-justify-content-space-between mb-3">
                            <strong>Signup Keys</strong>
                            <div class="field has-addons">
                                <p class="control">
                                    <input class="input is-small" type="number" min="1" v-model.number="admin.genCount"
                                        style="width:6rem">
                                </p>
                                <p class="control">
                                    <button class="button is-small is-primary" @click="generateKeys">Generate</button>
                                </p>
                            </div>
                        </div>
                        <div v-if="admin.keys.length===0" class="notification is-light">No keys yet.</div>
                        <table v-else class="table is-fullwidth is-narrow is-striped">
                            <thead>
                                <tr>
                                    <th>Token</th>
                                    <th>Used By</th>
                                    <th>State</th>
                                    <th style="width:200px">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="k in admin.keys" :key="k.token">
                                    <td><code style="word-break:break-all">{{ k.token }}</code></td>
                                    <td>{{ k.used_by || '-' }}</td>
                                    <td>
                                        <span v-if="k.revoked" class="tag is-warning is-light">revoked</span>
                                        <span v-else class="tag is-success is-light">active</span>
                                    </td>
                                    <td>
                                        <button class="button is-small" @click="copyToken(k.token)">Copy</button>
                                        <button class="button is-small is-warning" @click="revokeKey(k.token)"
                                            :disabled="k.revoked">Revoke</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <button class="button" @click="closeAdminConsole">Close</button>
                </footer>
            </div>
        </div>
    </div>

    {% endraw %}

    <!-- Load Vue and Showdown -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <script src="/static/main.js"></script>
</body>

</html>